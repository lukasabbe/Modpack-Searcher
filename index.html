<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Modrinth modpack finder</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Protest+Guerrilla&family=SUSE:wght@100..800&display=swap"
      rel="stylesheet"
    />
    <meta content="Modrinth modpack finder" property="og:title" />
    <meta content="Modrinth modpack finder" property="og:site_name" />
    <meta
      content="Find all modpack that dependens on a specific mod"
      property="og:description"
    />
    <meta content="https://finder.lukasabbe.com" property="og:url" />
  </head>
  <body>
    <div class="welcome">
      <h1>Modrinth modpack finder</h1>
    </div>
    <div class = "description">
        <p>Find all modpacks with an specific mod in it. Put in version, loader and id/slug</p>
    </div>
    <div class="mc_version">
      <select class="dropbtn" id="mc_versions"></select>
    </div>
    <div class="mc_loader">
      <select class="dropbtn" id="mc_loaders"></select>
    </div>
    <div class="mod_to_find">
      <input
        type="text"
        class="dropbtn"
        id="mod_to_find"
        placeholder="Mod ID"
      />
    </div>
    <div class="btntext">
      <p>Click the button bellow to start serching modpacks. (This will take a while)</p>
    </div>
    <div class="btndiv">
      <button id="Find" , class="btn">Find</button>
    </div>
    <div id="projects_div"></div>
    <script>
      const FETCH_OPTIONS = {
        method: "GET",
        headers: {
          "User-Agent": "lukasabbe/modrinth_randomizer/1.56.0",
        },
      };
      addEventListener("load", async (event) => {
        let response = await fetch(
          "https://api.modrinth.com/v2/tag/game_version",
          FETCH_OPTIONS
        );
        const versions = await response.json();
        const div_versions = [];
        versions.forEach((element) => {
          if (element.version_type == "release") {
            div_versions.push(
              `<option value="${element.version}">${element.version}</option>`
            );
          }
        });
        document.getElementById("mc_versions").innerHTML =
          div_versions.join("");
        response = await fetch(
          "https://api.modrinth.com/v2/tag/loader",
          FETCH_OPTIONS
        );
        const loaders = await response.json();
        const div_loaders = [];
        loaders.forEach((element) => {
          if (element.supported_project_types.includes("modpack")) {
            div_loaders.push(
              `<option value="${element.name}">${element.name}</option>`
            );
          }
        });
        document.getElementById("mc_loaders").innerHTML = div_loaders.join("");
      });
      document.getElementById("Find").addEventListener("click", async () => {
        const mc_version = document.getElementById("mc_versions").value;
        const mc_loader = document.getElementById("mc_loaders").value;
        const mod_to_find = document.getElementById("mod_to_find").value;

        const MC_VERSIONS = [mc_version]; // Versions you want to search for
        const MC_LOADER = mc_loader; // Loader you want to search for
        const MOD_QUERY = mod_to_find; // The project you want to find
        const DEBUG = false; //prints out when found a modpack with the mod

        var requests_per_sec = 0;
        var last_request = Date.now();
        var mc_versions_string;
        var mc_versions_string2;

        (async () => {
          let projects;
          let offset = 0;
          const foundModpacks = [];
          mc_versions_string = `"versions:${MC_VERSIONS.join('","versions:')}"`;
          mc_versions_string2 = `${MC_VERSIONS.join('","')}`;
          console.log("Searching for modpacks with mod: ", MOD_QUERY);
          do {
            projects = await search(offset);
            for (const project of projects.hits) {
              console.log("Checking project: ", project.title);
              document.getElementById("projects_div").innerHTML =
                "Checking project: " + project.title;
              const versions = await getVersions(project.project_id);
              let found = false;
              for (const version of versions) {
                for (const dependency of version.dependencies) {
                  if (dependency.project_id === MOD_QUERY && !found) {
                    foundModpacks.push(project.slug);
                    found = true;
                    if (DEBUG)
                      console.log(
                        `Found ${project.title} with version ${version.id}`
                      );
                  }
                }
              }
            }
            offset++;
            console.log("Offset: ", offset * 100);
          } while (projects.hits.length > 0);
          console.log("Found modpacks: ");
          let innerHTML = "";
          for (const modpack of foundModpacks) {
            console.log("https://modrinth.com/modpack/" + modpack);
            innerHTML += `<a href="https://modrinth.com/modpack/${modpack}">${modpack}</a><br>`;
          }
          document.getElementById("projects_div").innerHTML = innerHTML;
        })();

        async function search(offset) {
          await rateLimiterChecker();
          return new Promise((resolve, reject) => {
            fetch(
              `https://api.modrinth.com/v2/search?facets=[[${mc_versions_string}],["categories:${MC_LOADER}"],["project_type:modpack"]]&limit=100&offset=${
                offset * 100
              }`,
              FETCH_OPTIONS
            )
              .then((response) => response.json())
              .then((data) => resolve(data))
              .catch((err) => reject(err));
          });
        }
        async function getVersions(id) {
          await rateLimiterChecker();
          return new Promise((resolve, reject) => {
            fetch(
              `https://api.modrinth.com/v2/project/${id}/version?game_versions=["${mc_versions_string2}"]&loaders=["${MC_LOADER}"]`,
              FETCH_OPTIONS
            )
              .then((response) => response.json())
              .then((data) => resolve(data))
              .catch((err) => reject(err));
          });
        }

        async function rateLimiterChecker() {
          if (requests_per_sec > 5 && Date.now() - last_request < 1000) {
            console.log("Rate limit reached, waiting 200ms");
            requests_per_sec = 0;
            await wait(200);
          } else if (Date.now() - last_request >= 1000) {
            requests_per_sec = 0;
          }
          requests_per_sec++;
          last_request = Date.now();
        }

        function wait(ms) {
          return new Promise((resolve, reject) => {
            setTimeout(resolve, ms);
          });
        }
      });
    </script>
  </body>
</html>
